name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge on release PR
        if: ${{ steps.release.outputs.pr }}
        run: |
          echo "Release PR created: #${{ steps.release.outputs.pr }}"
          echo "Enabling auto-merge..."
          gh pr merge ${{ steps.release.outputs.pr }} --auto --squash --delete-branch || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log release information
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "âœ… Release created!"
          echo "Tag: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}"
          echo "SHA: ${{ steps.release.outputs.sha }}"
          echo ""
          echo "The CLI release workflow will be triggered by the tag."

      - name: Generate workflow summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ¤– Release Please Automation
          
          EOF
          
          if [ -n "${{ steps.release.outputs.pr }}" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“ Release PR Created/Updated
          
          - **PR**: #${{ steps.release.outputs.pr }}
          - **Auto-merge**: Enabled (will merge when checks pass)
          
          Review the PR to verify version bump and changelog before it merges.
          EOF
          elif [ "${{ steps.release.outputs.release_created }}" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸŽ‰ Release Created
          
          - **Tag**: ${{ steps.release.outputs.tag_name }}
          - **Version**: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
          - **SHA**: ${{ steps.release.outputs.sha }}
          
          The [CLI Release workflow](../actions/workflows/cli-release.yml) will build and publish:
          - Multi-platform binaries
          - Docker images  
          - Package manager updates
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## â„¹ï¸ No Release Needed
          
          No releasable commits found since last release.
          
          Commits with types \`feat\`, \`fix\`, or \`BREAKING CHANGE\` trigger releases.
          EOF
          fi

