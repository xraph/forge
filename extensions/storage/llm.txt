# Forge Storage Extension

## Purpose

Multi-backend object storage providing file uploads, downloads, and management with support for S3, Google Cloud Storage, Azure Blob Storage, and local filesystem.

## Key Components

- **Storage Interface**: Upload, download, delete files
- **Multiple Backends**: S3, GCS, Azure Blob, Local
- **Streaming**: Large file handling
- **Presigned URLs**: Temporary access links
- **Metadata**: File attributes and tags
- **DI Helpers**: Convenient service resolution from container

## Architecture

```
Storage Extension
├── Storage Interface
│   ├── Upload
│   ├── Download
│   └── Delete
├── Backends
│   ├── AWS S3
│   ├── Google Cloud Storage
│   ├── Azure Blob Storage
│   └── Local Filesystem
├── Streaming
│   └── Large File Support
└── Access Control
    └── Presigned URLs
```

## Public API

### Core Types

```go
type Storage interface {
    Upload(ctx context.Context, key string, data io.Reader, metadata Metadata) error
    Download(ctx context.Context, key string) (io.ReadCloser, error)
    Delete(ctx context.Context, key string) error
    List(ctx context.Context, prefix string) ([]Object, error)
    PresignedURL(ctx context.Context, key string, expiry time.Duration) (string, error)
}

type Object struct {
    Key          string
    Size         int64
    LastModified time.Time
    Metadata     map[string]string
}

type StorageManager struct {
    // Manages multiple storage backends
    Backend(name string) Storage
}
```

### DI Helpers (Recommended)

```go
// Get storage manager
manager := storage.MustGetManager(app.Container())

// Get default storage backend
s := storage.MustGetStorage(app.Container())

// Get named backend
s3 := storage.MustGetNamedBackend(app.Container(), "s3")

// Alternative: Get backend through manager
local := manager.Backend("local")
```

### Main Functions/Methods

```go
// Extension constructors
func NewExtension(opts ...ConfigOption) forge.Extension
func NewExtensionWithConfig(config Config) forge.Extension

// Configuration options
type ConfigOption func(*Config)
func WithDefault(name string) ConfigOption
func WithBackend(name string, backend BackendConfig) ConfigOption
func WithBackends(backends map[string]BackendConfig) ConfigOption
func WithLocalBackend(name, rootDir, baseURL string) ConfigOption
func WithS3Backend(name, bucket, region, endpoint string) ConfigOption
func WithPresignedURLs(enabled bool, expiry time.Duration) ConfigOption
func WithMaxUploadSize(size int64) ConfigOption
func WithChunkSize(size int) ConfigOption
func WithCDN(enabled bool, baseURL string) ConfigOption
func WithResilience(resilience ResilienceConfig) ConfigOption
func WithEnhancedBackend(enabled bool) ConfigOption
func WithRequireConfig(require bool) ConfigOption
func WithConfig(config Config) ConfigOption

// DI Helper functions
func GetManager(c forge.Container) (*StorageManager, error)
func MustGetManager(c forge.Container) *StorageManager
func GetStorage(c forge.Container) (Storage, error)
func MustGetStorage(c forge.Container) Storage
func GetNamedBackend(c forge.Container, name string) (Storage, error)
func MustGetNamedBackend(c forge.Container, name string) Storage

// Upload file
storage.Upload(ctx, "uploads/file.pdf", file, storage.WithContentType("application/pdf"))

// Download file
reader, _ := storage.Download(ctx, "uploads/file.pdf")
defer reader.Close()

// Get presigned URL
url, _ := storage.PresignUpload(ctx, "uploads/file.pdf", 1*time.Hour)
```

## Usage Examples

### Basic Usage with Variadic Options

```go
import "github.com/xraph/forge/extensions/storage"

// Register extension with variadic options
app := forge.New()
app.Use(storage.NewExtension(
    storage.WithDefault("local"),
    storage.WithLocalBackend("local", "./storage", "http://localhost:8080/files"),
))

// In a service constructor
type FileService struct {
    storage storage.Storage
}

func NewFileService(c forge.Container) *FileService {
    return &FileService{
        storage: storage.MustGetStorage(c), // Simple!
    }
}

func (s *FileService) UploadFile(ctx context.Context, key string, data io.Reader) error {
    return s.storage.Upload(ctx, key, data, 
        storage.WithContentType("application/pdf"),
    )
}
```

### Multi-Backend Usage

```go
type BackupService struct {
    primary storage.Storage
    backup  storage.Storage
}

func NewBackupService(c forge.Container) *BackupService {
    return &BackupService{
        primary: storage.MustGetNamedBackend(c, "s3"),
        backup:  storage.MustGetNamedBackend(c, "gcs"),
    }
}

func (s *BackupService) UploadWithBackup(ctx context.Context, key string, data io.Reader) error {
    // Upload to primary
    if err := s.primary.Upload(ctx, key, data); err != nil {
        return err
    }
    
    // Backup to secondary
    return s.backup.Upload(ctx, key, data)
}
```

### S3 Storage Configuration

```go
import "github.com/xraph/forge/extensions/storage"

// Using variadic options (recommended)
app := forge.New()
app.Use(storage.NewExtension(
    storage.WithDefault("s3"),
    storage.WithS3Backend("s3", "my-bucket", "us-east-1", ""),
    storage.WithPresignedURLs(true, 24*time.Hour),
))

// Or using complete config
config := storage.DefaultConfig()
config.Default = "s3"
config.Backends["s3"] = storage.BackendConfig{
    Type: storage.BackendTypeS3,
    Config: map[string]interface{}{
        "bucket": "my-bucket",
        "region": "us-east-1",
    },
}
app.Use(storage.NewExtensionWithConfig(config))

// Get storage using DI helper
s := storage.MustGetStorage(app.Container())

// Upload file
file, _ := os.Open("document.pdf")
defer file.Close()

s.Upload(ctx, "documents/doc.pdf", file,
    storage.WithContentType("application/pdf"),
    storage.WithMetadata(map[string]string{
        "user":    "123",
        "project": "abc",
    }),
)

// Download file
reader, _ := s.Download(ctx, "documents/doc.pdf")
defer reader.Close()
io.Copy(os.Stdout, reader)

// Get presigned URL
url, _ := s.PresignDownload(ctx, "documents/doc.pdf", 24*time.Hour)
// Share URL with users for temporary access
```

## Configuration

```yaml
extensions:
  storage:
    driver: s3
    
    s3:
      bucket: my-bucket
      region: us-east-1
      access_key: ${AWS_ACCESS_KEY}
      secret_key: ${AWS_SECRET_KEY}
    
    gcs:
      bucket: my-bucket
      project: my-project
      credentials: ${GCS_CREDENTIALS}
    
    local:
      path: ./uploads
```

## Notes

### Production Readiness
- ✅ Multiple backend support
- ✅ Streaming uploads/downloads
- ✅ Presigned URLs
- ✅ Metadata support

### License
MIT License - Part of Forge Framework

