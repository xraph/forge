# Forge Feature Flags Extension

## Purpose

Feature flag management system for controlled feature rollouts, A/B testing, and progressive deployment. Supports multiple providers (LaunchDarkly, Flagsmith, Unleash, in-memory) with real-time flag updates.

## Key Components

- **Feature Flag Management**: Enable/disable features dynamically
- **Multiple Providers**: LaunchDarkly, Flagsmith, Unleash, in-memory
- **Targeting Rules**: User-based, percentage-based rollouts
- **A/B Testing**: Experiment management
- **Real-time Updates**: Flag changes without deployment

## Architecture

```
Features Extension
├── Flag Evaluation
│   ├── Boolean Flags
│   ├── String/Number Flags
│   └── JSON Flags
├── Providers
│   ├── LaunchDarkly
│   ├── Flagsmith
│   ├── Unleash
│   └── In-Memory
├── Targeting
│   ├── User Targeting
│   ├── Percentage Rollouts
│   └── Custom Rules
└── Caching
    └── Local Flag Cache
```

## Public API

### Core Types

```go
type FeatureFlags interface {
    IsEnabled(ctx context.Context, flagKey string, user User) (bool, error)
    GetVariation(ctx context.Context, flagKey string, user User) (interface{}, error)
    Track(ctx context.Context, event string, user User, data map[string]interface{}) error
}

type User struct {
    Key        string
    Email      string
    Attributes map[string]interface{}
}
```

### Main Functions/Methods

```go
// Extension
func NewExtension(config Config) forge.Extension

// Get feature flags service (safe, returns error)
func Get(c forge.Container) (*Service, error)

// Get feature flags service (panics on error, for startup code)
func MustGet(c forge.Container) *Service

// Convenience helpers for forge.App
func GetFromApp(app forge.App) (*Service, error)
func MustGetFromApp(app forge.App) *Service

// Check flag
enabled := service.IsEnabled(ctx, "new-checkout", userCtx)
if enabled {
    // Use new checkout flow
}

// Get string flag
theme := service.GetString(ctx, "theme", userCtx, "light")

// Get number flag
maxItems := service.GetInt(ctx, "max-items", userCtx, 100)
```

## Usage Examples

### Basic Feature Flag

```go
import "github.com/xraph/forge/extensions/features"

app := forge.NewApp(forge.AppConfig{
    Extensions: []forge.Extension{
        features.NewExtension(
            features.WithEnabled(true),
            features.WithProvider("local"),
            features.WithLocalFlags(map[string]features.FlagConfig{
                "new-ui": {
                    Key:     "new-ui",
                    Type:    "boolean",
                    Enabled: true,
                },
            }),
        ),
    },
})

// Get feature flags service using helper
service := features.MustGetFromApp(app)

// Check flag with user context
userCtx := features.NewUserContext("user-123").
    WithEmail("user@example.com")

if service.IsEnabled(ctx, "new-ui", userCtx) {
    // Show new UI
} else {
    // Show old UI
}
```

### Multivariate Flags

```go
// Get string flag value
theme := service.GetString(ctx, "theme", userCtx, "light")

switch theme {
case "dark":
    // Apply dark theme
case "light":
    // Apply light theme
case "auto":
    // Auto theme based on system
}

// Get number flag
maxItems := service.GetInt(ctx, "max-items", userCtx, 100)

// Get JSON flag
config := service.GetJSON(ctx, "api-config", userCtx, defaultConfig)
```

### Percentage Rollouts

```go
// Configure flag with percentage rollout
// new-algorithm: 10% of users see new algorithm

if service.IsEnabled(ctx, "new-algorithm", userCtx) {
    result = newAlgorithm()  // 10% of users
} else {
    result = oldAlgorithm()  // 90% of users
}
```

### A/B Testing

```go
// Get variant using string flag
variant := service.GetString(ctx, "checkout-experiment", userCtx, "control")

switch variant {
case "control":
    // Original checkout (50%)
    showCheckoutV1()
case "variant-a":
    // Test variant A (25%)
    showCheckoutV2()
case "variant-b":
    // Test variant B (25%)
    showCheckoutV3()
}

// Track metrics separately using your analytics system
analytics.Track("purchase-completed", map[string]interface{}{
    "amount": 99.99,
    "variant": variant,
    "user_id": userCtx.UserID,
})
```

## Configuration

```yaml
extensions:
  features:
    provider: launchdarkly
    sdk_key: ${LAUNCHDARKLY_SDK_KEY}
    
    # Cache settings
    cache_ttl: 5m
    stream_enabled: true  # Real-time updates
```

## Dependencies

### External
- github.com/launchdarkly/go-server-sdk/v7 - LaunchDarkly
- github.com/Flagsmith/flagsmith-go-client/v3 - Flagsmith
- github.com/Unleash/unleash-client-go/v4 - Unleash

### Internal
- github.com/xraph/forge - Core framework

## Notes

### Production Readiness
- ✅ Multiple provider support
- ✅ Real-time flag updates
- ✅ A/B testing support
- ✅ Percentage rollouts
- ✅ User targeting

### Best Practices
1. Use feature flags for new features
2. Remove flags after full rollout
3. Track flag usage metrics
4. Test both enabled/disabled paths
5. Use meaningful flag names
6. Document flag purposes
7. Implement fallback values
8. Monitor flag performance

### License
MIT License - Part of Forge Framework

