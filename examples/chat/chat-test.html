<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Multi-User WebSocket Test with Typing Indicators</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .user-panel {
            display: inline-block;
            width: 45%;
            margin: 10px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            vertical-align: top;
        }
        .user-header {
            background: #667eea;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            font-size: 12px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .message.received { background: #e3f2fd; }
        .message.sent { background: #f3e5f5; }
        .message.system { background: #fff3e0; font-style: italic; }
        .message.typing {
            background: #e8f5e8;
            font-style: italic;
            color: #666;
            animation: fadeInOut 2s ease-in-out infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .typing-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 11px;
            font-style: italic;
            min-height: 20px;
            display: flex;
            align-items: center;
        }

        .typing-indicator.hidden {
            display: none;
        }

        .typing-dots {
            display: inline-block;
            margin-left: 5px;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s steps(4) infinite;
        }

        @keyframes typing {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input[type="text"] {
            width: 70%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #667eea;
            outline: none;
        }

        .typing-status {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
            min-height: 12px;
        }

        .controls {
            margin: 10px 0;
        }

        .features-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .feature-demo {
            display: inline-block;
            margin: 5px;
            padding: 8px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .feature-demo:hover {
            background: #218838;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üß™ Enhanced Multi-User WebSocket Chat Test with Typing Indicators</h1>
    <p>This test demonstrates real-time typing indicators, user presence, and multi-user chat functionality. The typing indicators work automatically as you type and show when other users are typing.</p>

    <!-- Alice Panel -->
    <div class="user-panel">
        <div class="user-header">
            üë©‚Äçüíº Alice
        </div>
        <div id="alice-status" class="status disconnected">Disconnected</div>

        <div class="controls">
            <button id="alice-connect">Connect</button>
            <button id="alice-disconnect" disabled>Disconnect</button>
        </div>

        <div class="typing-indicator" id="alice-typing-indicator">
            <span id="alice-typing-text"></span>
            <span class="typing-dots"></span>
        </div>

        <div class="controls">
            <input type="text" id="alice-message" placeholder="Type message (typing indicators work automatically)..." disabled>
            <button id="alice-send" disabled>Send</button>
        </div>

        <div class="typing-status" id="alice-typing-status"></div>

        <div id="alice-messages" class="messages"></div>
    </div>

    <!-- Bob Panel -->
    <div class="user-panel">
        <div class="user-header">
            üë®‚Äçüíª Bob
        </div>
        <div id="bob-status" class="status disconnected">Disconnected</div>

        <div class="controls">
            <button id="bob-connect">Connect</button>
            <button id="bob-disconnect" disabled>Disconnect</button>
        </div>

        <div class="typing-indicator" id="bob-typing-indicator">
            <span id="bob-typing-text"></span>
            <span class="typing-dots"></span>
        </div>

        <div class="controls">
            <input type="text" id="bob-message" placeholder="Type message (typing indicators work automatically)..." disabled>
            <button id="bob-send" disabled>Send</button>
        </div>

        <div class="typing-status" id="bob-typing-status"></div>

        <div id="bob-messages" class="messages"></div>
    </div>

    <div style="clear: both; margin-top: 30px;">
        <h3>Test Scenarios:</h3>
        <button onclick="connectBoth()">Connect Both Users</button>
        <button onclick="sendTestMessages()">Send Test Messages</button>
        <button onclick="simulateTypingSequence()">Demo Typing Indicators</button>
        <button onclick="simulateConversation()">Simulate Full Conversation</button>
        <button onclick="disconnectBoth()">Disconnect Both</button>
    </div>

    <div class="features-section">
        <h4>‚ú® Enhanced Features:</h4>
        <div>
            <button class="feature-demo" onclick="testTypingIndicators()">Test Typing Indicators</button>
            <button class="feature-demo" onclick="testRapidTyping()">Test Rapid Typing</button>
            <button class="feature-demo" onclick="testLongMessage()">Test Long Message</button>
            <button class="feature-demo" onclick="testInterruptedTyping()">Test Interrupted Typing</button>
            <button class="feature-demo" onclick="clearAllMessages()">Clear All Messages</button>
        </div>

        <h4>Instructions:</h4>
        <ol>
            <li><strong>Connect Both Users:</strong> Click "Connect Both Users" to establish WebSocket connections</li>
            <li><strong>Real-time Typing:</strong> Start typing in either input field - you'll see typing indicators appear for the other user automatically</li>
            <li><strong>Message Flow:</strong> Send messages and watch them appear in both chat windows with timestamps</li>
            <li><strong>Typing Demo:</strong> Use "Demo Typing Indicators" to see an automated demonstration</li>
            <li><strong>Multi-tab Testing:</strong> Open this page in multiple browser tabs to test real multi-user scenarios</li>
            <li><strong>Feature Tests:</strong> Try the various feature demo buttons to test different scenarios</li>
        </ol>

        <h4>üîß Technical Features:</h4>
        <ul>
            <li>‚úÖ Real-time typing indicators with automatic start/stop detection</li>
            <li>‚úÖ User presence notifications (join/leave events)</li>
            <li>‚úÖ Message history and timestamps</li>
            <li>‚úÖ Connection state management</li>
            <li>‚úÖ Error handling and reconnection logic</li>
            <li>‚úÖ Typing timeout handling (auto-stop after 3 seconds of inactivity)</li>
            <li>‚úÖ Visual feedback for all user interactions</li>
        </ul>
    </div>
</div>

<script>
    class ChatUser {
        constructor(name, userId) {
            this.name = name;
            this.userId = userId;
            this.ws = null;
            this.isConnected = false;
            this.isTyping = false;
            this.typingTimeout = null;
            this.lastTypingTime = 0;

            // Get DOM elements
            this.statusEl = document.getElementById(`${name.toLowerCase()}-status`);
            this.messagesEl = document.getElementById(`${name.toLowerCase()}-messages`);
            this.messageInput = document.getElementById(`${name.toLowerCase()}-message`);
            this.connectBtn = document.getElementById(`${name.toLowerCase()}-connect`);
            this.disconnectBtn = document.getElementById(`${name.toLowerCase()}-disconnect`);
            this.sendBtn = document.getElementById(`${name.toLowerCase()}-send`);
            this.typingIndicator = document.getElementById(`${name.toLowerCase()}-typing-indicator`);
            this.typingText = document.getElementById(`${name.toLowerCase()}-typing-text`);
            this.typingStatus = document.getElementById(`${name.toLowerCase()}-typing-status`);

            this.setupEventListeners();
            this.hideTypingIndicator();
        }

        setupEventListeners() {
            this.connectBtn.onclick = () => this.connect();
            this.disconnectBtn.onclick = () => this.disconnect();
            this.sendBtn.onclick = () => this.sendMessage();

            this.messageInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    this.sendMessage();
                } else {
                    this.handleTyping();
                }
            };

            this.messageInput.oninput = () => this.handleTyping();
            this.messageInput.onblur = () => this.stopTyping();
        }

        connect() {
            const wsUrl = `ws://localhost:8080/ws/chat?user_id=${this.userId}&username=${this.name}`;

            this.updateStatus('connecting', 'Connecting...');

            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
                this.isConnected = true;
                this.updateStatus('connected', 'Connected');
                this.addMessage(`${this.name} connected to chat`, 'system');
                this.updateTypingStatus('Ready to chat!');
            };

            this.ws.onmessage = (event) => {
                this.handleMessage(event);
            };

            this.ws.onclose = () => {
                this.isConnected = false;
                this.updateStatus('disconnected', 'Disconnected');
                this.addMessage(`${this.name} disconnected`, 'system');
                this.updateTypingStatus('');
                this.hideTypingIndicator();
            };

            this.ws.onerror = (error) => {
                console.error(`${this.name} WebSocket error:`, error);
                this.updateStatus('disconnected', 'Connection Error');
                this.updateTypingStatus('Connection error');
            };
        }

        disconnect() {
            if (this.ws) {
                this.stopTyping();
                this.ws.close();
            }
        }

        sendMessage() {
            const text = this.messageInput.value.trim();
            if (!text || !this.isConnected) return;

            // Stop typing when sending message
            this.stopTyping();

            const message = {
                id: Math.random().toString(36).substr(2, 9),
                type: 'event',
                roomId: 'room-1',
                data: {
                    type: 'chat_message',
                    content: text,
                    user_id: this.userId,
                    username: this.name,
                    timestamp: new Date().toISOString()
                },
                timestamp: new Date().toISOString()
            };

            this.ws.send(JSON.stringify(message));
            this.addMessage(`${this.name}: ${text}`, 'sent');
            this.messageInput.value = '';
            this.updateTypingStatus('Message sent!');
        }

        handleTyping() {
            if (!this.isConnected) return;

            const now = Date.now();
            this.lastTypingTime = now;

            // Start typing if not already typing
            if (!this.isTyping) {
                this.startTyping();
            }

            // Clear existing timeout and set new one
            if (this.typingTimeout) {
                clearTimeout(this.typingTimeout);
            }

            // Stop typing after 3 seconds of inactivity
            this.typingTimeout = setTimeout(() => {
                if (Date.now() - this.lastTypingTime >= 2900) {
                    this.stopTyping();
                }
            }, 3000);
        }

        startTyping() {
            if (this.isTyping || !this.isConnected) return;

            this.isTyping = true;
            this.updateTypingStatus('Typing...');

            const typingMessage = {
                id: Math.random().toString(36).substr(2, 9),
                type: 'typing',
                roomId: 'room-1',
                data: {
                    type: 'typing_start',
                    user_id: this.userId,
                    username: this.name,
                    timestamp: new Date().toISOString()
                },
                timestamp: new Date().toISOString()
            };

            this.ws.send(JSON.stringify(typingMessage));
        }

        stopTyping() {
            if (!this.isTyping || !this.isConnected) return;

            this.isTyping = false;
            this.updateTypingStatus('');

            if (this.typingTimeout) {
                clearTimeout(this.typingTimeout);
                this.typingTimeout = null;
            }

            const typingMessage = {
                id: Math.random().toString(36).substr(2, 9),
                type: 'event',
                roomId: 'room-1',
                data: {
                    type: 'typing_stop',
                    user_id: this.userId,
                    username: this.name,
                    timestamp: new Date().toISOString()
                },
                timestamp: new Date().toISOString()
            };

            this.ws.send(JSON.stringify(typingMessage));
        }

        handleMessage(rawEvent) {
            try {
                const event = JSON.parse(rawEvent.data);
                const message = event.data;

                switch (message.type) {
                    case 'welcome':
                        this.addMessage(`Welcome: ${message.message}`, 'system');
                        break;

                    case 'chat_message':
                        if (message.user_id !== this.userId) {
                            this.addMessage(`${message.username}: ${message.content}`, 'received');
                            // Hide typing indicator when message is received
                            this.hideTypingIndicator();
                        }
                        break;

                    case 'user_joined':
                        if (message.user_id !== this.userId) {
                            this.addMessage(`${message.username} joined the chat`, 'system');
                        }
                        break;

                    case 'user_left':
                        this.addMessage(`${message.username} left the chat`, 'system');
                        this.hideTypingIndicator();
                        break;

                    case 'typing_start':
                        if (message.user_id !== this.userId) {
                            this.showTypingIndicator(message.username);
                        }
                        break;

                    case 'typing_stop':
                        if (message.user_id !== this.userId) {
                            this.hideTypingIndicator();
                        }
                        break;

                    case 'heartbeat':
                        // Handle heartbeat silently
                        break;

                    default:
                        console.log(`${this.name} received unknown message:`, message);
                }
            } catch (error) {
                console.error(`${this.name} message parse error:`, error);
                this.addMessage(`Error parsing message: ${error.message}`, 'system');
            }
        }

        showTypingIndicator(username) {
            this.typingText.textContent = `${username} is typing`;
            this.typingIndicator.classList.remove('hidden');
        }

        hideTypingIndicator() {
            this.typingIndicator.classList.add('hidden');
            this.typingText.textContent = '';
        }

        updateStatus(type, text) {
            this.statusEl.textContent = text;
            this.statusEl.className = `status ${type}`;

            const isConnected = type === 'connected';
            this.connectBtn.disabled = isConnected;
            this.disconnectBtn.disabled = !isConnected;
            this.messageInput.disabled = !isConnected;
            this.sendBtn.disabled = !isConnected;
        }

        updateTypingStatus(text) {
            this.typingStatus.textContent = text;
        }

        addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'system' ? 'üîî' : type === 'sent' ? 'üì§' : 'üì•';

            messageDiv.innerHTML = `${prefix} <strong>${timestamp}</strong> ${text}`;

            this.messagesEl.appendChild(messageDiv);
            this.messagesEl.scrollTop = this.messagesEl.scrollHeight;

            // Add visual feedback for new messages
            if (type === 'received') {
                messageDiv.style.animation = 'fadeInOut 0.5s ease-in-out';
            }
        }

        clearMessages() {
            this.messagesEl.innerHTML = '';
        }

        // Simulate typing for demonstrations
        simulateTyping(text, callback) {
            if (!this.isConnected) return;

            let index = 0;
            const typeChar = () => {
                if (index < text.length) {
                    this.messageInput.value = text.substring(0, index + 1);
                    this.handleTyping();
                    index++;
                    setTimeout(typeChar, 100 + Math.random() * 100); // Vary typing speed
                } else {
                    setTimeout(() => {
                        if (callback) callback();
                    }, 500);
                }
            };

            this.messageInput.value = '';
            typeChar();
        }
    }

    // Create user instances
    const alice = new ChatUser('Alice', 'alice');
    const bob = new ChatUser('Bob', 'bob');

    // Global test functions
    function connectBoth() {
        alice.connect();
        setTimeout(() => bob.connect(), 1000); // Stagger connections
    }

    function disconnectBoth() {
        alice.disconnect();
        bob.disconnect();
    }

    function sendTestMessages() {
        if (!alice.isConnected || !bob.isConnected) {
            alert('Both users must be connected first!');
            return;
        }

        // Alice sends a message
        setTimeout(() => {
            alice.messageInput.value = 'Hello Bob! How are you today?';
            alice.sendMessage();
        }, 500);

        // Bob replies
        setTimeout(() => {
            bob.messageInput.value = 'Hi Alice! I\'m doing great, thanks for asking! üòä';
            bob.sendMessage();
        }, 2500);

        // Alice responds
        setTimeout(() => {
            alice.messageInput.value = 'That\'s wonderful to hear! Want to test the typing indicators?';
            alice.sendMessage();
        }, 5000);
    }

    function simulateTypingSequence() {
        if (!alice.isConnected || !bob.isConnected) {
            alert('Both users must be connected first!');
            return;
        }

        // Alice starts typing
        alice.simulateTyping('Hey Bob, watch the typing indicator...', () => {
            setTimeout(() => alice.sendMessage(), 1000);
        });

        // Bob starts typing after Alice is done
        setTimeout(() => {
            bob.simulateTyping('I can see you typing Alice! This is so cool!', () => {
                setTimeout(() => bob.sendMessage(), 1000);
            });
        }, 4000);
    }

    function simulateConversation() {
        if (!alice.isConnected || !bob.isConnected) {
            alert('Both users must be connected first!');
            return;
        }

        const conversation = [
            { user: alice, message: 'Hey! Want to see a full conversation demo?', delay: 1000 },
            { user: bob, message: 'Sure! I love testing these features.', delay: 3000 },
            { user: alice, message: 'Great! Notice how the typing indicators work?', delay: 2500 },
            { user: bob, message: 'Yes! They appear and disappear perfectly.', delay: 3500 },
            { user: alice, message: 'And they timeout automatically after 3 seconds!', delay: 4000 },
            { user: bob, message: 'Amazing work on this WebSocket implementation! üöÄ', delay: 3000 }
        ];

        let currentIndex = 0;
        function playNextMessage() {
            if (currentIndex < conversation.length) {
                const { user, message, delay } = conversation[currentIndex];

                setTimeout(() => {
                    user.simulateTyping(message, () => {
                        setTimeout(() => {
                            user.sendMessage();
                            currentIndex++;
                            playNextMessage();
                        }, 500);
                    });
                }, delay);
            }
        }

        playNextMessage();
    }

    // Feature test functions
    function testTypingIndicators() {
        if (!alice.isConnected || !bob.isConnected) {
            alert('Both users must be connected first!');
            return;
        }

        alice.addMessage('üß™ Testing typing indicators...', 'system');
        bob.addMessage('üß™ Testing typing indicators...', 'system');

        // Test overlapping typing
        alice.simulateTyping('Testing typing indicators...', null);
        setTimeout(() => {
            bob.simulateTyping('Me too! This is a great test...', null);
        }, 1500);
    }

    function testRapidTyping() {
        if (!alice.isConnected || !bob.isConnected) {
            alert('Both users must be connected first!');
            return;
        }

        const messages = ['Quick!', 'Rapid!', 'Fire!', 'Messages!'];
        messages.forEach((msg, index) => {
            setTimeout(() => {
                alice.messageInput.value = msg;
                alice.sendMessage();
            }, index * 600);
        });
    }

    function testLongMessage() {
        if (!alice.isConnected) {
            alice.connect();
            setTimeout(() => testLongMessage(), 2000);
            return;
        }

        const longMessage = 'This is a very long message to test how the typing indicator works with extended typing sessions. It should maintain the typing indicator for the duration of typing and properly handle the timeout mechanism when typing stops.';

        alice.simulateTyping(longMessage, () => {
            setTimeout(() => alice.sendMessage(), 1000);
        });
    }

    function testInterruptedTyping() {
        if (!alice.isConnected || !bob.isConnected) {
            alert('Both users must be connected first!');
            return;
        }

        // Alice starts typing but doesn't finish
        alice.simulateTyping('I am typing but will get interrupt', null);

        // Bob interrupts with a message
        setTimeout(() => {
            bob.messageInput.value = 'Hey Alice! I\'m interrupting your typing!';
            bob.sendMessage();
        }, 2000);

        // Alice continues after interruption
        setTimeout(() => {
            alice.messageInput.value = 'Oh! You interrupted me, but that\'s okay! üòÑ';
            alice.sendMessage();
        }, 4000);
    }

    function clearAllMessages() {
        alice.clearMessages();
        bob.clearMessages();
        alice.addMessage('üßπ Messages cleared', 'system');
        bob.addMessage('üßπ Messages cleared', 'system');
    }

    // Initialize with welcome message
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Enhanced WebSocket Chat Test with Typing Indicators loaded!');
        console.log('Features: Real-time typing indicators, user presence, message history');
    });
</script>
</body>
</html>